{"version":3,"file":"signaling-server.js","names":["_index","require","_connectionHandlerSimplePeer","PEER_ID_LENGTH","exports","startSignalingServerSimplePeer","serverOptions","WebSocketServer","wss","peerById","Map","peersByRoom","serverClosed","on","clear","_loop","promiseWait","minTime","Date","now","SIMPLE_PEER_PING_INTERVAL","Array","from","values","forEach","peer","lastPing","disconnectSocket","id","peerId","reason","get","socket","close","undefined","rooms","roomId","room","delete","size","ws","randomCouchString","set","sendMessage","type","yourPeerId","err","console","error","dir","msgEvent","message","JSON","parse","toString","validateIdString","includes","getFromMapOrCreate","Set","add","otherPeerId","otherPeer","otherPeerIds","senderPeerId","receiver","receiverPeerId","port","server","localUrl","msgString","stringify","send","length"],"sources":["../../../../src/plugins/replication-webrtc/signaling-server.ts"],"sourcesContent":["import {\n    getFromMapOrCreate,\n    promiseWait,\n    randomCouchString\n} from '../utils/index.ts';\nimport {\n    SIMPLE_PEER_PING_INTERVAL,\n    type PeerMessage\n} from './connection-handler-simple-peer.ts';\nimport type {\n    WebSocket,\n    ServerOptions\n} from 'ws';\n\nexport const PEER_ID_LENGTH = 12;\nexport type ServerPeer = {\n    id: string;\n    socket: WebSocket;\n    rooms: string[];\n    lastPing: number;\n};\n\n\n/**\n * Starts a WebRTC signaling server\n * that can be used in tests.\n*/\nexport async function startSignalingServerSimplePeer(\n    serverOptions: ServerOptions\n) {\n    const { WebSocketServer } = await import('ws');\n    const wss = new WebSocketServer(serverOptions);\n\n    const peerById = new Map<string, ServerPeer>();\n    const peersByRoom = new Map<string, Set<string>>();\n\n    let serverClosed = false;\n    wss.on('close', () => {\n        serverClosed = true\n        peerById.clear();\n        peersByRoom.clear();\n    });\n\n\n    /**\n     * Clients can disconnect without telling that to the\n     * server. Therefore we have to automatically disconnect clients that\n     * have not send a ping message in the last 2 minutes.\n     */\n    (async () => {\n        while (!serverClosed) {\n            await promiseWait(1000 * 20);\n            const minTime = Date.now() - SIMPLE_PEER_PING_INTERVAL;\n            Array.from(peerById.values()).forEach(peer => {\n                if (peer.lastPing < minTime) {\n                    disconnectSocket(peer.id, 'no ping for 2 minutes');\n                }\n            });\n\n        }\n    })();\n\n    function disconnectSocket(peerId: string, reason: string) {\n        const peer = peerById.get(peerId);\n        if (peer) {\n            peer.socket.close(undefined, reason);\n            peer.rooms.forEach(roomId => {\n                const room = peersByRoom.get(roomId);\n                room?.delete(peerId);\n                if (room && room.size === 0) {\n                    peersByRoom.delete(roomId);\n                }\n            });\n        }\n        peerById.delete(peerId);\n    }\n\n    wss.on('connection', function (ws) {\n        /**\n         * PeerID is created by the server to prevent malicious\n         * actors from falsy claiming other peoples ids.\n         */\n        const peerId = randomCouchString(PEER_ID_LENGTH);\n        const peer: ServerPeer = {\n            id: peerId,\n            socket: ws,\n            rooms: [],\n            lastPing: Date.now()\n        };\n        peerById.set(peerId, peer);\n\n        sendMessage(ws, { type: 'init', yourPeerId: peerId });\n\n\n        ws.on('error', err => {\n            console.error('SERVER ERROR:');\n            console.dir(err);\n            disconnectSocket(peerId, 'socket errored');\n        });\n        ws.on('close', () => {\n            disconnectSocket(peerId, 'socket disconnected');\n        });\n\n        ws.on('message', msgEvent => {\n            peer.lastPing = Date.now();\n            const message = JSON.parse(msgEvent.toString());\n            const type = message.type;\n            switch (type) {\n                case 'join':\n                    const roomId = message.room;\n                    if (\n                        !validateIdString(roomId) ||\n                        !validateIdString(peerId)\n                    ) {\n                        disconnectSocket(peerId, 'invalid ids');\n                        return;\n                    }\n\n                    if (peer.rooms.includes(peerId)) {\n                        return;\n                    }\n\n\n                    const room = getFromMapOrCreate(\n                        peersByRoom,\n                        message.room,\n                        () => new Set()\n                    );\n\n                    room.add(peerId);\n\n                    // tell everyone about new room state\n                    room.forEach(otherPeerId => {\n                        const otherPeer = peerById.get(otherPeerId);\n                        if (otherPeer) {\n                            sendMessage(\n                                otherPeer.socket,\n                                {\n                                    type: 'joined',\n                                    otherPeerIds: Array.from(room)\n                                }\n                            );\n                        }\n                    });\n                    break;\n                case 'signal':\n                    if (\n                        message.senderPeerId !== peerId\n                    ) {\n                        disconnectSocket(peerId, 'spoofed sender');\n                        return;\n                    }\n                    const receiver = peerById.get(message.receiverPeerId);\n                    if (receiver) {\n                        sendMessage(\n                            receiver.socket,\n                            message\n                        );\n                    }\n                    break;\n                case 'ping':\n                    break;\n                default:\n                    disconnectSocket(peerId, 'unknown message type ' + type);\n            }\n\n        });\n    });\n\n    return {\n        port: serverOptions.port,\n        server: wss,\n        localUrl: 'ws://localhost:' + serverOptions.port\n    };\n}\n\n\nfunction sendMessage(ws: WebSocket, message: PeerMessage) {\n    const msgString = JSON.stringify(message);\n    ws.send(msgString);\n}\n\nfunction validateIdString(roomId: string): boolean {\n    if (\n        typeof roomId === 'string' &&\n        roomId.length > 5 &&\n        roomId.length < 100\n    ) {\n        return true;\n    } else {\n        return false;\n    }\n}\n"],"mappings":"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"}