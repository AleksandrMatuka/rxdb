{"version":3,"file":"config.js","names":["_index","require","_broadcastChannel","_nodeEvents","_interopRequireDefault","path","_interopRequireWildcard","_nodeUrl","_index2","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","isDeno","exports","window","isBun","process","versions","bun","isNode","config","setConfig","newConfig","initDone","getConfig","initTestEnvironment","ensureNotFalsy","getEnvVariables","ret","forEach","k","Deno","env","__karma__","ENV_VARIABLES","DEFAULT_STORAGE","isFastMode","NODE_ENV","err","rootPath","getRootPath","broadcastChannelEnforceOptions","type","oldConsoleLog","console","log","bind","oldConsoleDir","dir","newLog","value","isPromise","Error","JSON","stringify","setMaxListeners","events","EventEmitter","defaultMaxListeners","__filename","url","fileURLToPath","import","meta","__dirname","dirname","join","startTime","performance","now","logTime","msg","diff","getEncryptedStorage","baseStorage","storage","getStorage","hasEncryption","wrappedKeyEncryptionCryptoJsStorage","isNotOneOfTheseStorages","storageNames","isName","name","includes","getPassword","Promise","resolve","randomCouchString"],"sources":["../../../../src/plugins/test-utils/config.ts"],"sourcesContent":["/// <reference path=\"../../../node_modules/@types/mocha/index.d.ts\" />\nimport {\n    ensureNotFalsy,\n    isPromise,\n    randomCouchString\n} from '../utils/index.ts';\nimport {\n    enforceOptions as broadcastChannelEnforceOptions\n} from 'broadcast-channel';\nimport events from 'node:events';\nimport * as path from 'node:path';\nimport url from 'node:url';\nimport type { RxStorage, RxTestStorage } from '../../types';\nimport { wrappedKeyEncryptionCryptoJsStorage } from '../encryption-crypto-js/index.ts';\n\nexport type TestConfig = {\n    storage: RxTestStorage;\n};\n\nexport const isDeno = typeof window !== 'undefined' && 'Deno' in window;\nexport const isBun = typeof process !== 'undefined' && !!process.versions.bun;\nexport const isNode = !isDeno && !isBun && typeof window === 'undefined';\n\nlet config: TestConfig;\n\nexport function setConfig(newConfig: TestConfig) {\n    config = newConfig;\n}\n\nlet initDone = false;\nexport function getConfig() {\n    if (!initDone) {\n        initTestEnvironment();\n        initDone = true;\n    }\n    return ensureNotFalsy(config, 'testConfig not set')\n}\n\n\ndeclare const Deno: any;\nfunction getEnvVariables() {\n    if (isDeno) {\n        const ret: any = {};\n        [\n            'DEFAULT_STORAGE',\n            'NODE_ENV'\n        ].forEach(k => {\n            ret[k] = Deno.env.get(k);\n        });\n        return ret;\n    }\n\n    return isBun || isNode ? process.env : (window as any).__karma__.config.env;\n}\nexport const ENV_VARIABLES = getEnvVariables();\nexport const DEFAULT_STORAGE = ENV_VARIABLES.DEFAULT_STORAGE as string;\n\nexport function isFastMode(): boolean {\n    try {\n        return ENV_VARIABLES.NODE_ENV === 'fast';\n    } catch (err) {\n        return false;\n    }\n}\n\nlet rootPath = '';\nexport function getRootPath() {\n    return rootPath;\n}\n\nexport function initTestEnvironment() {\n    if (ENV_VARIABLES.NODE_ENV === 'fast') {\n        broadcastChannelEnforceOptions({\n            type: 'simulate'\n        });\n    }\n\n    /**\n     * Overwrite the console for easier debugging\n     */\n    const oldConsoleLog = console.log.bind(console);\n    const oldConsoleDir = console.dir.bind(console);\n    function newLog(this: typeof console, value: any) {\n        if (isPromise(value)) {\n            oldConsoleDir(value);\n            throw new Error('cannot log Promise(), you should await it first');\n        }\n        if (typeof value === 'string' || typeof value === 'number') {\n            oldConsoleLog(value);\n            return;\n        }\n        try {\n            JSON.stringify(value);\n            oldConsoleLog(JSON.stringify(value, null, 4));\n        } catch (err) {\n            oldConsoleDir(value);\n        }\n    }\n    console.log = newLog.bind(console);\n    console.dir = newLog.bind(console);\n\n    console.log('DEFAULT_STORAGE: ' + DEFAULT_STORAGE);\n\n    if (isNode) {\n        process.setMaxListeners(100);\n\n        events.EventEmitter.defaultMaxListeners = 100;\n\n        const __filename = url.fileURLToPath(import.meta.url);\n        const __dirname = path.dirname(__filename);\n\n        rootPath = path.join(__dirname, '../../../../');\n        console.log('rootPath: ' + rootPath);\n\n        /**\n         * Add a global function to process, so we can debug timings\n         */\n        (process as any).startTime = performance.now();\n        (process as any).logTime = (msg: string = '') => {\n            const diff = performance.now() - (process as any).startTime;\n            console.log('process logTime(' + msg + ') ' + diff + 'ms');\n        };\n    }\n}\n\nexport function getEncryptedStorage(baseStorage = getConfig().storage.getStorage()): RxStorage<any, any> {\n    const ret = config.storage.hasEncryption ?\n        baseStorage :\n        wrappedKeyEncryptionCryptoJsStorage({\n            storage: baseStorage\n        });\n    return ret;\n}\n\nexport function isNotOneOfTheseStorages(storageNames: string[]) {\n    const isName = getConfig().storage.name;\n    if (storageNames.includes(isName)) {\n        return false;\n    } else {\n        return true;\n    }\n}\n\n\nexport function getPassword(): Promise<string> {\n    if (getConfig().storage.hasEncryption) {\n        return ensureNotFalsy(getConfig().storage.hasEncryption)();\n    } else {\n        return Promise.resolve('test-password-' + randomCouchString(10));\n    }\n}\n"],"mappings":"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"}