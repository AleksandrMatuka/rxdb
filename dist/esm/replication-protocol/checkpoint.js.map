{"version":3,"file":"checkpoint.js","names":["getComposedPrimaryKeyOfDocumentData","stackCheckpoints","createRevision","ensureNotFalsy","getDefaultRevision","getDefaultRxDocumentMeta","now","getLastCheckpointDoc","state","direction","checkpointDocId","input","metaInstance","schema","isCheckpoint","itemId","checkpointResult","findDocumentsById","checkpointDoc","lastCheckpointDoc","checkpointData","undefined","setCheckpoint","checkpoint","previousCheckpointDoc","events","canceled","getValue","JSON","stringify","newDoc","id","_deleted","_attachments","_meta","_rev","lwt","checkpointKey","result","bulkWrite","previous","document","sucessDoc","success","error","status","documentInDb","getCheckpointKey","hash","hashFunction","identifier","forkInstance","databaseName","collectionName","join"],"sources":["../../../src/replication-protocol/checkpoint.ts"],"sourcesContent":["import { getComposedPrimaryKeyOfDocumentData } from '../rx-schema-helper.ts';\nimport { stackCheckpoints } from '../rx-storage-helper.ts';\nimport type {\n    RxDocumentData,\n    RxStorageInstanceReplicationInput,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationDirection,\n    RxStorageReplicationMeta\n} from '../types/index.d.ts';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta,\n    now\n} from '../plugins/utils/index.ts';\n\nexport async function getLastCheckpointDoc<RxDocType, CheckpointType>(\n    state: RxStorageInstanceReplicationState<RxDocType>,\n    direction: RxStorageReplicationDirection\n): Promise<undefined | CheckpointType> {\n    const checkpointDocId = getComposedPrimaryKeyOfDocumentData(\n        state.input.metaInstance.schema,\n        {\n            isCheckpoint: '1',\n            itemId: direction\n        }\n    );\n    const checkpointResult = await state.input.metaInstance.findDocumentsById(\n        [\n            checkpointDocId\n        ],\n        false\n    );\n\n    const checkpointDoc = checkpointResult[0];\n    state.lastCheckpointDoc[direction] = checkpointDoc;\n    if (checkpointDoc) {\n        return checkpointDoc.checkpointData;\n    } else {\n        return undefined;\n    }\n}\n\n\n/**\n * Sets the checkpoint,\n * automatically resolves conflicts that appear.\n */\nexport async function setCheckpoint<RxDocType, CheckpointType>(\n    state: RxStorageInstanceReplicationState<RxDocType>,\n    direction: RxStorageReplicationDirection,\n    checkpoint: CheckpointType\n) {\n    let previousCheckpointDoc = state.lastCheckpointDoc[direction];\n    if (\n        checkpoint &&\n        /**\n         * If the replication is already canceled,\n         * we do not write a checkpoint\n         * because that could mean we write a checkpoint\n         * for data that has been fetched from the master\n         * but not been written to the child.\n         */\n        !state.events.canceled.getValue() &&\n        /**\n         * Only write checkpoint if it is different from before\n         * to have less writes to the storage.\n         */\n        (\n            !previousCheckpointDoc ||\n            JSON.stringify(previousCheckpointDoc.checkpointData) !== JSON.stringify(checkpoint)\n        )\n    ) {\n        const newDoc: RxDocumentData<RxStorageReplicationMeta<RxDocType, CheckpointType>> = {\n            id: '',\n            isCheckpoint: '1',\n            itemId: direction,\n            _deleted: false,\n            _attachments: {},\n            checkpointData: checkpoint,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision()\n        };\n        newDoc.id = getComposedPrimaryKeyOfDocumentData(\n            state.input.metaInstance.schema,\n            newDoc\n        );\n        while (!state.events.canceled.getValue()) {\n            /**\n             * Instead of just storing the new checkpoint,\n             * we have to stack up the checkpoint with the previous one.\n             * This is required for plugins like the sharding RxStorage\n             * where the changeStream events only contain a Partial of the\n             * checkpoint.\n             */\n            if (previousCheckpointDoc) {\n                newDoc.checkpointData = stackCheckpoints([\n                    previousCheckpointDoc.checkpointData,\n                    newDoc.checkpointData\n                ]);\n            }\n            newDoc._meta.lwt = now();\n            newDoc._rev = createRevision(\n                await state.checkpointKey,\n                previousCheckpointDoc\n            );\n            const result = await state.input.metaInstance.bulkWrite([{\n                previous: previousCheckpointDoc,\n                document: newDoc\n            }], 'replication-set-checkpoint');\n\n            const sucessDoc = result.success[0];\n            if (sucessDoc) {\n                state.lastCheckpointDoc[direction] = sucessDoc;\n                return;\n            } else {\n                const error = result.error[0];\n                if (error.status !== 409) {\n                    throw error;\n                } else {\n                    previousCheckpointDoc = ensureNotFalsy(error.documentInDb);\n                    newDoc._rev = createRevision(\n                        await state.checkpointKey,\n                        previousCheckpointDoc\n                    );\n                }\n            }\n        }\n    }\n}\n\nexport async function getCheckpointKey<RxDocType>(\n    input: RxStorageInstanceReplicationInput<RxDocType>\n): Promise<string> {\n    const hash = await input.hashFunction([\n        input.identifier,\n        input.forkInstance.databaseName,\n        input.forkInstance.collectionName\n    ].join('||'));\n    return 'rx_storage_replication_' + hash;\n}\n"],"mappings":"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"}