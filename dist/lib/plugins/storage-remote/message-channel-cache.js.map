{"version":3,"file":"message-channel-cache.js","names":["_utils","require","MESSAGE_CHANNEL_CACHE_BY_IDENTIFIER","Map","exports","CACHE_ITEM_BY_MESSAGE_CHANNEL","WeakMap","getMessageChannelCache","identifier","getFromMapOrCreate","getMessageChannel","settings","cacheKeys","keepAlive","cacheKey","getCacheKey","cacheItem","newCacheItem","refCount","messageChannel","messageChannelCreator","then","set","existingCacheItem","closeMessageChannel","getFromMapOrThrow","delete","close","PROMISE_RESOLVE_VOID","slice","unshift","join"],"sources":["../../../../src/plugins/storage-remote/message-channel-cache.ts"],"sourcesContent":["import {\n    PROMISE_RESOLVE_VOID,\n    getFromMapOrCreate,\n    getFromMapOrThrow\n} from '../utils';\nimport {\n    RemoteMessageChannel,\n    RxStorageRemoteSettings\n} from './storage-remote-types';\n\nexport type RemoteMessageChannelCacheItem = {\n    identifier: string;\n    cacheKey: string;\n    messageChannel: Promise<RemoteMessageChannel>;\n    refCount: number;\n    keepAlive: boolean;\n};\n\nexport const MESSAGE_CHANNEL_CACHE_BY_IDENTIFIER = new Map<string, Map<string, RemoteMessageChannelCacheItem>>();\nconst CACHE_ITEM_BY_MESSAGE_CHANNEL = new WeakMap<RemoteMessageChannel, RemoteMessageChannelCacheItem>();\n\nfunction getMessageChannelCache(\n    identifier: string\n) {\n    return getFromMapOrCreate(\n        MESSAGE_CHANNEL_CACHE_BY_IDENTIFIER,\n        identifier,\n        () => new Map()\n    );\n}\n\nexport function getMessageChannel(\n    settings: RxStorageRemoteSettings,\n    cacheKeys: string[],\n    keepAlive: boolean = false\n): Promise<RemoteMessageChannel> {\n    const cacheKey = getCacheKey(settings, cacheKeys);\n    const cacheItem = getFromMapOrCreate(\n        getMessageChannelCache(settings.identifier),\n        cacheKey,\n        () => {\n            const newCacheItem: RemoteMessageChannelCacheItem = {\n                identifier: settings.identifier,\n                cacheKey,\n                keepAlive,\n                refCount: 1,\n                messageChannel: settings.messageChannelCreator()\n                    .then((messageChannel) => {\n                        CACHE_ITEM_BY_MESSAGE_CHANNEL.set(messageChannel, newCacheItem);\n                        return messageChannel;\n                    }),\n            };\n            return newCacheItem;\n        },\n        (existingCacheItem) => {\n            existingCacheItem.refCount = existingCacheItem.refCount + 1;\n        }\n    );\n    return cacheItem.messageChannel;\n}\n\n\nexport function closeMessageChannel(\n    messageChannel: RemoteMessageChannel\n): Promise<void> {\n    const cacheItem = getFromMapOrThrow(CACHE_ITEM_BY_MESSAGE_CHANNEL, messageChannel);\n    cacheItem.refCount = cacheItem.refCount - 1;\n    if (cacheItem.refCount === 0 && !cacheItem.keepAlive) {\n        getMessageChannelCache(cacheItem.identifier).delete(cacheItem.cacheKey);\n        return messageChannel.close();\n    } else {\n        return PROMISE_RESOLVE_VOID;\n    }\n}\n\nfunction getCacheKey(\n    settings: RxStorageRemoteSettings,\n    cacheKeys: string[]\n): string {\n    cacheKeys = cacheKeys.slice(0);\n    cacheKeys.unshift(settings.identifier);\n    return cacheKeys.join('||');\n}\n"],"mappings":";;;;;;;;AAAA,IAAAA,MAAA,GAAAC,OAAA;AAkBO,IAAMC,mCAAmC,GAAG,IAAIC,GAAG,EAAsD;AAACC,OAAA,CAAAF,mCAAA,GAAAA,mCAAA;AACjH,IAAMG,6BAA6B,GAAG,IAAIC,OAAO,EAAuD;AAExG,SAASC,sBAAsBA,CAC3BC,UAAkB,EACpB;EACE,OAAO,IAAAC,yBAAkB,EACrBP,mCAAmC,EACnCM,UAAU,EACV,MAAM,IAAIL,GAAG,EAAE,CAClB;AACL;AAEO,SAASO,iBAAiBA,CAC7BC,QAAiC,EACjCC,SAAmB,EACnBC,SAAkB,GAAG,KAAK,EACG;EAC7B,IAAMC,QAAQ,GAAGC,WAAW,CAACJ,QAAQ,EAAEC,SAAS,CAAC;EACjD,IAAMI,SAAS,GAAG,IAAAP,yBAAkB,EAChCF,sBAAsB,CAACI,QAAQ,CAACH,UAAU,CAAC,EAC3CM,QAAQ,EACR,MAAM;IACF,IAAMG,YAA2C,GAAG;MAChDT,UAAU,EAAEG,QAAQ,CAACH,UAAU;MAC/BM,QAAQ;MACRD,SAAS;MACTK,QAAQ,EAAE,CAAC;MACXC,cAAc,EAAER,QAAQ,CAACS,qBAAqB,EAAE,CAC3CC,IAAI,CAAEF,cAAc,IAAK;QACtBd,6BAA6B,CAACiB,GAAG,CAACH,cAAc,EAAEF,YAAY,CAAC;QAC/D,OAAOE,cAAc;MACzB,CAAC;IACT,CAAC;IACD,OAAOF,YAAY;EACvB,CAAC,EACAM,iBAAiB,IAAK;IACnBA,iBAAiB,CAACL,QAAQ,GAAGK,iBAAiB,CAACL,QAAQ,GAAG,CAAC;EAC/D,CAAC,CACJ;EACD,OAAOF,SAAS,CAACG,cAAc;AACnC;AAGO,SAASK,mBAAmBA,CAC/BL,cAAoC,EACvB;EACb,IAAMH,SAAS,GAAG,IAAAS,wBAAiB,EAACpB,6BAA6B,EAAEc,cAAc,CAAC;EAClFH,SAAS,CAACE,QAAQ,GAAGF,SAAS,CAACE,QAAQ,GAAG,CAAC;EAC3C,IAAIF,SAAS,CAACE,QAAQ,KAAK,CAAC,IAAI,CAACF,SAAS,CAACH,SAAS,EAAE;IAClDN,sBAAsB,CAACS,SAAS,CAACR,UAAU,CAAC,CAACkB,MAAM,CAACV,SAAS,CAACF,QAAQ,CAAC;IACvE,OAAOK,cAAc,CAACQ,KAAK,EAAE;EACjC,CAAC,MAAM;IACH,OAAOC,2BAAoB;EAC/B;AACJ;AAEA,SAASb,WAAWA,CAChBJ,QAAiC,EACjCC,SAAmB,EACb;EACNA,SAAS,GAAGA,SAAS,CAACiB,KAAK,CAAC,CAAC,CAAC;EAC9BjB,SAAS,CAACkB,OAAO,CAACnB,QAAQ,CAACH,UAAU,CAAC;EACtC,OAAOI,SAAS,CAACmB,IAAI,CAAC,IAAI,CAAC;AAC/B"}